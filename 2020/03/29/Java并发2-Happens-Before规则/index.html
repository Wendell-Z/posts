<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Java并发2:Happens-Before规则, YOLO">
    <meta name="description" content="">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Java并发2:Happens-Before规则 | YOLO</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 5.2.0"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">YOLO</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">YOLO</div>
        <div class="logo-desc">
            
            Never really desperate, only the lost of the soul.
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/Wendell-Z" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/Wendell-Z" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('https://images-1252818907.cos.ap-chengdu.myqcloud.com/images/java并发编程.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Java并发2:Happens-Before规则</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Java/">
                                <span class="chip bg-color">Java</span>
                            </a>
                        
                            <a href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">
                                <span class="chip bg-color">并发编程</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                    <div class="post-cate">
                        <i class="fas fa-bookmark fa-fw icon-category"></i>
                        
                            <a href="/categories/%E5%90%8E%E7%AB%AF/" class="post-category">
                                后端
                            </a>
                        
                    </div>
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2020-03-29
                </div>
                

                

                
                <div class="info-break-policy">
                    <i class="far fa-file-word fa-fw"></i>文章字数:&nbsp;&nbsp;
                    4.7k
                </div>
                

                

                
                    <div id="busuanzi_container_page_pv" class="info-break-policy">
                        <i class="far fa-eye fa-fw"></i>阅读次数:&nbsp;&nbsp;
                        <span id="busuanzi_value_page_pv"></span>
                    </div>
				
            </div>
        </div>
        <hr class="clearfix">

        
        <!-- 是否加载使用自带的 prismjs. -->
        <link rel="stylesheet" href="/libs/prism/prism.css">
        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h3 id="Java并发2-Happens-Before规则"><a href="#Java并发2-Happens-Before规则" class="headerlink" title="Java并发2:Happens-Before规则"></a>Java并发2:Happens-Before规则</h3><p>由上篇总结可知：导致可见性的原因是缓存，导致有序性的原因是编译优化。</p>
<p>则解决可见性、有序性最直接的办法就是<strong>禁用缓存和编译优化</strong>，但会出现性能问题。所以<strong>应该按需禁用缓存以及编译优化</strong>。</p>
<p>Java 内存模型是个很复杂的规范，可以从不同视角来解读，站在我们这些程序员的视角，本质上可以理解为，<strong>Java 内存模型规范了 JVM 如何提供按需禁用缓存和编译优化的方法</strong>。</p>
<p>具体来说，这些方法包括 <code>volatile</code>、<code>synchronized </code>和 <code>final </code>三个关键字，以及<strong>六项 Happens-Before 规则</strong>。</p>
<pre class="line-numbers language-volatile```：JDK1.5对该关键字做了增强，在原有禁止指令重排序&禁用缓存的功能上，通过**读写屏障**保证了**传递性**。" data-language="volatile```：JDK1.5对该关键字做了增强，在原有禁止指令重排序&禁用缓存的功能上，通过**读写屏障**保证了**传递性**。"><code class="language-volatile```：JDK1.5对该关键字做了增强，在原有禁止指令重排序&禁用缓存的功能上，通过**读写屏障**保证了**传递性**。">
**Happens-Before 约束了编译器的优化行为，虽允许编译器优化，但是要求编译器优化后一定遵守 Happens-Before 规则。**

### 1. 程序的顺序性规则

在一个线程中，按照**程序控制流顺序**(而非代码顺序)，前面的操作 Happens-Before 于后续的任意操作。

### 2. volatile 变量规则

指对一个 volatile 变量的写操作， Happens-Before 于后续对这个 volatile 变量的读操作。

### 3. 传递性

这条规则是指如果 A Happens-Before B，且 B Happens-Before C，那么 A Happens-Before C。

### 4. 管程中锁的规则

指对一个锁的解锁 Happens-Before 于后续对这个锁的加锁。

**管程**是一种通用的同步原语，在 Java 中指的就是 &#96;&#96;&#96;synchronized&#96;&#96;&#96;，&#96;&#96;&#96;synchronized&#96;&#96;&#96; 是 Java 里对管程的实现。

### 5. 线程 start() 规则

指主线程 A 启动子线程 B 后，子线程 B 能够看到主线程在启动子线程 B 前的操作。

主线程调用B.start()之前，启动B线程之前所有对共享变量的修改，B线程皆可见。

### 6. 线程 join() 规则

主线程 A 等待子线程 B 完成（主线程 A 通过调用子线程 B 的&#96;&#96;&#96; join()&#96;&#96;&#96; 方法实现），当子线程 B 完成后（主线程 A 中&#96;&#96;&#96; join() &#96;&#96;&#96;方法返回），主线程能够看到子线程的操作，即对共享变量的操作。

### 7.线程中断规则：

对线程interrupt()方法的调用先行发生于被中断线程的代码检测到中断事件的发生，可以通过&#96;&#96;&#96;Thread.interrupted()&#96;&#96;&#96;方法检测到是否有中断发生。

### 8.对象终结规则

一个对象的初始化完成(构造函数执行结束)先行发生于它的&#96;&#96;&#96;finalize()&#96;&#96;&#96;方法的开始。

**Note：代码执行时在时间上的先后顺序与&#96;Happends-Before&#96;原则基本没有因果关系。**

---------------------------------------

### 补充-内存模型

Java内存模型规定所有变量存到主内存，可类比就是机器上的内存，当然仍处于虚拟机内存的一部分。

每条线程有自己的工作内存，可类比就是处理器缓存，里面会有对被该线程使用的主内存变量的副本。

线程先把要用的数据从主内存中读取到自己的工作内存中，再操作，操作完再写会主内存。

### 补充-volatile关键字

2个性质：

可见性：一个线程对volatile变量的修改，其他线程可以立即看见。

**每次**（指令级别）操作volatile变量，强制从主内存中读； 每次写volatile变量，强制向主内存中写。

禁止指令重排序：通过底层汇编代码&#96;lock add1 $0x0,(%esp)&#96;实现内存屏障，这样对volatile变量操作的指令的后面的指令就不会排到前面。

### 补充-final关键字

**final 修饰变量时，初衷是告诉编译器：这个变量生而不变，可以最大限度优化。**

Java 编译器在 1.5 以前的版本的对该关键字有优化问题：类似利用双重检查方法创建单例，构造函数的错误重排导致线程可能看到 final 变量的值会变化。

在 1.5 以后 Java 内存模型对**&#96;&#96;&#96;final&#96;&#96;&#96;类型变量的重排进行了约束**。**前提是保证提供正确构造函数没有“引用逃逸”。**

**如何正确使用&#96;&#96;&#96;final&#96;&#96;&#96;保证没有引用逃逸？**



&gt;**How can final fields appear to change their values?**
&gt;
&gt;One of the best examples of how final fields&#39; values can be seen to change involves one particular implementation of the &#96;String&#96; class.
&gt;
&gt;A &#96;String&#96; can be implemented as an object with three fields -- a character array, an offset into that array, and a length. The rationale for implementing &#96;String&#96; this way, instead of having only the character array, is that it lets multiple &#96;String&#96; and &#96;StringBuffer&#96; objects share the same character array and avoid additional object allocation and copying. So, for example, the method &#96;String.substring()&#96; can be implemented by creating a new string which shares the same character array with the original &#96;String&#96; and merely differs in the length and offset fields. For a &#96;String&#96;, these fields are all final fields.
&gt;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>
<blockquote>
<p>String s1 = “/usr/tmp”;<br>String s2 = s1.substring(4); //该处底层代码调用 new String(array, offset, length)</p>
<pre class="line-numbers language-none"><code class="language-none">
&gt;The string &#96;s2&#96; will have an offset of 4 and a length of 4. But, under the old model, it was possible for another thread to see the offset as having the default value of 0, and then later see the correct value of 4, it will appear as if the string &quot;&#x2F;usr&quot; changes to &quot;&#x2F;tmp&quot;.

&gt;The original Java Memory Model allowed this behavior; several JVMs have exhibited this behavior. The new Java Memory Model makes this illegal.

上面这段话解释了为什么可能出现线程访问final值时不同的情况。

举了一个很典型的例子：(需要重新组织下语言)

首先&#96;&#96;&#96;String&#96;&#96;&#96;类是由3字段实现的：一个字符数组(&#96;&#96;&#96;array&#96;&#96;&#96;)，数组偏移量(&#96;&#96;&#96;offset&#96;&#96;&#96;)，数组长度(&#96;&#96;&#96;length&#96;&#96;&#96;)。

为什么&#96;&#96;&#96;String&#96;&#96;&#96;类不直接只用一个字符数组实现就行了？反而要用这3个字段？

原因是让&#96;&#96;&#96;String&#96;&#96;&#96;类的&#96;&#96;&#96;StringBuffer&#96;&#96;&#96;类能复用同一个字符串底层的数组，这样就不用重复复制开辟内存空间了。

比如&#96;&#96;&#96;String s  &#x3D; &quot;abc&quot;&#96;&#96;&#96;，底层是有&#96;&#96;&#96;a&#96;&#96;&#96;，&#96;&#96;&#96;b&#96;&#96;&#96;，&#96;&#96;&#96;c&#96;&#96;&#96;3个字符的数组，那么实际上&#96;&#96;&#96;&quot;a&quot;&#96;&#96;&#96;，&#96;&#96;&#96;&quot;b&quot;&#96;&#96;&#96;，&#96;&#96;&#96;&quot;c&quot;&#96;&#96;&#96;，&#96;&#96;&#96;&quot;ab&quot;&#96;&#96;&#96;,&#96;&#96;&#96;&quot;ac&quot;&#96;&#96;&#96;，&#96;&#96;&#96;&quot;bc&quot;&#96;&#96;&#96;这些字符串都可以复用&#96;&#96;&#96;&quot;abc&quot;&#96;&#96;&#96;的数组，只要这几个字符串的&#96;&#96;&#96;offset&#96;&#96;&#96;和&#96;&#96;&#96;length&#96;&#96;&#96;做出相应的变化就可以。

因此，一个&#96;&#96;&#96;String&#96;&#96;&#96;对象中的&#96;&#96;&#96;offset&#96;&#96;&#96;和&#96;&#96;&#96;length&#96;&#96;&#96;字段也肯定是&#96;&#96;&#96;final&#96;&#96;&#96;的。

从上面第2行代码可以看到，字符串&#96;&#96;&#96;s2&#96;&#96;&#96;是个&#96;&#96;&#96;offset&#96;&#96;&#96;为4，&#96;&#96;&#96;length&#96;&#96;&#96;为4的字符串，它和字符串&#96;&#96;&#96;s1&#96;&#96;&#96;底层都指向的同一个字符数组。

在旧的内存模型中，其他线程访问&#96;&#96;&#96;s2&#96;&#96;&#96;时，可能会发现&#96;&#96;&#96;offset&#96;&#96;&#96;为0，之后&#96;&#96;&#96;offset&#96;&#96;&#96;才显示正确值4。

这样就会让访问&#96;&#96;&#96;s2&#96;&#96;&#96;的线程发现，&#96;&#96;&#96;s2&#96;&#96;&#96;可能出现&#96;&#96;&#96;s2&#x3D;&quot;&#x2F;usr&quot;&#96;&#96;&#96;的情况（&#96;&#96;&#96;offset&#x3D;0&#96;&#96;&#96;，&#96;&#96;&#96;length&#x3D;4&#96;&#96;&#96;），等到&#96;&#96;&#96;offset&#96;&#96;&#96;成为4的时候，&#96;&#96;&#96;s2&#96;&#96;&#96;才为&#96;&#96;&#96;&quot;&#x2F;tmp&quot;&#96;&#96;&#96;；

**这种情况的产生，就是指令重排优化导致先返回了&#96;&#96;&#96;s2&#96;&#96;&#96;的指针，再去给&#96;&#96;&#96;offset&#96;&#96;&#96;初始化造成的。**

**新的Java内存模型已经禁止了这种重排行为。**（JDK1.5之后）

&gt;**How do final fields work under the new JMM?**
&gt;The values for an object&#39;s final fields are set in its constructor. Assuming the object is constructed &quot;correctly&quot;, once an object is constructed, the values assigned to the final fields in the constructor will be visible to all other threads without synchronization. In addition, the visible values for any other object or array referenced by those final fields will be at least as up-to-date as the final fields.

&gt;What does it mean for an object to be properly constructed? It simply means that no reference to the object being constructed is allowed to &quot;escape&quot; during construction. (See Safe Construction Techniques for examples.)  In other words, do not place a reference to the object being constructed anywhere where another thread might be able to see it; do not assign it to a static field, do not register it as a listener with any other object, and so on. These tasks should be done after the constructor completes, not in the constructor.

&#96;&#96;&#96;final&#96;&#96;&#96;字段的值在构造器中设置。假设对象被正确构造，一旦对象构造完成，那么其他线程不用同步就可以看得到&#96;&#96;&#96;final&#96;&#96;&#96;字段的值。另外，被这些&#96;&#96;&#96;final&#96;&#96;&#96;字段引用的对象或者数组的可见值肯定至少是跟&#96;&#96;&#96;final&#96;&#96;&#96;字段一样新。

那么怎样才能说一个构造器是被合理适当地构造了？

简单说就是在对象构造过程中，对该对象的引用都不允许**“引用逃逸”**(escape)。（详见[ Safe Construction Techniques for examples](http:&#x2F;&#x2F;www-106.ibm.com&#x2F;developerworks&#x2F;java&#x2F;library&#x2F;j-jtp0618.html)）

**也就是说不要把对该对象的引用放在任何该对象会被构造并且其他线程还能看的到的地方，不要在构造器中分配&#96;&#96;&#96;static&#96;&#96;&#96;变量，不要在构造器中注册&#96;&#96;&#96;listener&#96;&#96;&#96;等等。这种操作应该放在构造器完成之后，而不是构造器里面。**

&gt;以下是正确的使用方式：

&gt;&#96;&#96;&#96;java
&gt;class FinalFieldExample &#123;
&gt;final int x;
&gt;int y;
&gt;static FinalFieldExample f;
&gt;public FinalFieldExample() &#123;
&gt;x &#x3D; 3;
&gt;y &#x3D; 4;
&gt;&#125;

&gt;static void writer() &#123;
&gt;f &#x3D; new FinalFieldExample();
&gt;&#125;

&gt;static void reader() &#123;
&gt;if (f !&#x3D; null) &#123;
int i &#x3D; f.x;
int j &#x3D; f.y;
&gt;&#125;
&gt;&#125;
&gt;&#125;<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>The class above is an example of how final fields should be used. A thread executing <code>reader</code> is guaranteed to see the value 3 for <code>f.x</code>, because it is final. It is not guaranteed to see the value 4 for <code>y</code>, because it is not final. </p>
</blockquote>
<p>从代码中可以看到，<strong>构造器仅仅是对属性值进行了初始化，构造器中并没有任何引用该对象的代码</strong>。</p>
<p>这样一个线程在执行<code>reader()</code>方法时，一定能够看得到<code>f.x=3</code>。</p>
<p>因为它是<code>final</code>的，这样尽管可能在构造<code>f</code>对象时，先返回了对象指针（参考上篇文章双重检查方法创建单例），但Java内存模型一定保证了返回指针前把<code>final</code>字段的值给初始化了，但不一定看得到<code>f.y=4</code>。</p>
<blockquote>
<p>If <code>FinalFieldExample</code>‘s constructor looked like this:</p>
<pre class="line-numbers language-java" data-language="java"><code class="language-java"><span class="token operator">></span><span class="token keyword">public</span> <span class="token class-name">FinalFieldExample</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">&#123;</span> <span class="token comment">// bad!</span>
<span class="token operator">></span>x <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token operator">></span>y <span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token operator">></span><span class="token comment">// bad construction - allowing this to escape</span>
<span class="token operator">></span>global<span class="token punctuation">.</span>obj <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token operator">></span><span class="token punctuation">&#125;</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<p>then threads that read the reference to <code>this </code>from <code>global.obj</code> are <strong>not</strong> guaranteed to see 3 for <code>x</code>.</p>
</blockquote>
<p>这种就是不好的例子，因为其他线程调用global.obj时，它可能还没初始化，就造成了空指针异常。</p>
<blockquote>
<p>The ability to see the correctly constructed value for the field is nice, but if the field itself is a reference, then you also want your code to see the up to date values for the object (or array) to which it points. If your field is a final field, this is also guaranteed. So, you can have a final pointer to an array and not have to worry about other threads seeing the correct values for the array reference, but incorrect values for the contents of the array. Again, by “correct” here, we mean “up to date as of the end of the object’s constructor”, not “the latest value available”.</p>
<p>Now, having said all of this, if, after a thread constructs an immutable object (that is, an object that only contains final fields), you want to ensure that it is seen correctly by all of the other thread, you <strong>still</strong> typically need to use synchronization. There is no other way to ensure, for example, that the reference to the immutable object will be seen by the second thread. The guarantees the program gets from final fields should be carefully tempered with a deep and careful understanding of how concurrency is managed in your code.</p>
<p>There is no defined behavior if you want to use JNI to change final fields.</p>
<p>——<a target="_blank" rel="noopener" href="http://www.cs.umd.edu/~pugh/java/memoryModel/jsr-133-faq.html#finalWrong"><strong>JSR 133 (Java Memory Model) FAQ</strong> Jeremy Manson and Brian Goetz, February 2004</a></p>
</blockquote>
<p><del>如果一个<code>final</code>字段引用的是对象或者数组，Java内存模型保证<code>final</code>字段的指针指向是正确的，但是不保证对象或数组中的值是正确的。</del></p>
<p><del>所以<strong>“正确构造”</strong>意思是，构造器完成后，final的引用都更新了，但不保证你引用的对象或数组中的值是最新的。</del></p>
<p><del>如果一个线程构造了一个<strong>不变的对象</strong>（即该对象中只有<code>final</code>字段），你想确定这个对象是否能够正确地被其他线程看见，你仍需要用 <code>synchronization</code>。你要防止构造后被其他线程更改了<code>final</code>字段引用的对象或数组的值。</del></p>
<h3 id="补充-逃逸分析"><a href="#补充-逃逸分析" class="headerlink" title="补充-逃逸分析"></a>补充-逃逸分析</h3><p>JVM优化技术，通过编译时分析对象动态作用域，判断当一个对象在方法内定义后，是否可能逃逸，分成几个不同的逃逸程度。</p>
<p>不逃逸：变量仅在方法内使用，别的方法和线程无法访问。</p>
<p>方法逃逸：通过传参，被外部方法引用，但在同一线程内。</p>
<p>线程逃逸：通过赋值，变量会被其他线程访问。</p>
<p>优化方法：</p>
<ul>
<li><p>栈上分配</p>
<p>  如果对象无方法逃逸，对象可以之间放在方法的栈帧中，执行完即可销毁。HotSpot还没做此项优化。</p>
</li>
<li><p>标量替换</p>
<p>  如果对象无方法逃逸，对象可以化整为零，只需要在方法栈中存成员变量进行计算即可。</p>
</li>
<li><p>同步消除</p>
<p>  如果对象无线程逃逸，即无线程安全问题，就可以自动优化调加锁释放锁的操作。</p>
</li>
</ul>
<h3 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h3><p>有一个共享变量 <code>abc</code>，在一个线程里设置了 <code>abc</code> 的值<code> abc=3</code>，有哪些办法可以让其他线程能够看到<code>abc==3</code>？</p>
<p>1.声明共享变量<code>abc</code>，并使用<code>volatile</code>关键字修饰<code>abc</code>。<br>2.声明共享变量<code>abc</code>，在<code>synchronized</code>关键字对<code>abc</code>的赋值代码块加锁，由于<code>Happen-before</code>管程锁的规则，可以使得后续的线程可以看到<code>abc</code>的值。<br>3.<code>A</code>线程启动后，使用<code>A.JOIN()</code>方法来完成运行，后续线程再启动，则一定可以看到<code>abc==3</code>。</p>
<h3 id="别人的总结"><a href="#别人的总结" class="headerlink" title="别人的总结"></a>别人的总结</h3><blockquote>
<ol>
<li><p>为什么定义Java内存模型？现代计算机体系大部是采用的对称多处理器的体系架构。每个处理器均有独立的寄存器组和缓存，多个处理器可同时执行同一进程中的不同线程，这里称为处理器的乱序执行。在Java中，不同的线程可能访问同一个共享或共享变量。如果任由编译器或处理器对这些访问进行优化的话，很有可能出现无法想象的问题，这里称为编译器的重排序。除了处理器的乱序执行、编译器的重排序，还有内存系统的重排序。因此Java语言规范引入了Java内存模型，通过定义多项规则对编译器和处理器进行限制，主要是针对可见性和有序性。</p>
</li>
<li><p>三个基本原则：原子性、可见性、有序性。</p>
</li>
<li><p>Java内存模型涉及的几个关键词：锁、volatile字段、final修饰符与对象的安全发布。其中：第一是锁，锁操作是具备happens-before关系的，解锁操作happens-before之后对同一把锁的加锁操作。实际上，在解锁的时候，JVM需要强制刷新缓存，使得当前线程所修改的内存对其他线程可见。第二是volatile字段，volatile字段可以看成是一种不保证原子性的同步但保证可见性的特性，其性能往往是优于锁操作的。但是，频繁地访问 volatile字段也会出现因为不断地强制刷新缓存而影响程序的性能的问题。第三是final修饰符，final修饰的实例字段则是涉及到新建对象的发布问题。当一个对象包含final修饰的实例字段时，其他线程能够看到已经初始化的final实例字段，这是安全的。</p>
</li>
<li><p>Happens-Before的7个规则：<br>(1).程序次序规则：在一个线程内，按照程序代码顺序，书写在前面的操作先行发生于书写在后面的操作。准确地说，应该是控制流顺序而不是程序代码顺序，因为要考虑分支、循环等结构。<br>(2).管程锁定规则：一个unlock操作先行发生于后面对同一个锁的lock操作。这里必须强调的是同一个锁，而”后面”是指时间上的先后顺序。<br>(3).volatile变量规则：对一个volatile变量的写操作先行发生于后面对这个变量的读操作，这里的”后面”同样是指时间上的先后顺序。<br>(4).线程启动规则：Thread对象的start()方法先行发生于此线程的每一个动作。<br>(5).线程终止规则：线程中的所有操作都先行发生于对此线程的终止检测，我们可以通过Thread.join（）方法结束、Thread.isAlive（）的返回值等手段检测到线程已经终止执行。<br>(6).线程中断规则：对线程interrupt()方法的调用先行发生于被中断线程的代码检测到中断事件的发生，可以通过Thread.interrupted()方法检测到是否有中断发生。<br>(7).对象终结规则：一个对象的初始化完成(构造函数执行结束)先行发生于它的finalize()方法的开始</p>
</li>
<li><p>Happens-Before的1个特性：传递性。</p>
</li>
<li><p>Java内存模型底层怎么实现的？主要是通过内存屏障(memory barrier)禁止重排序的，即时编译器根据具体的底层体系架构，将这些内存屏障替换成具体的 CPU 指令。对于编译器而言，内存屏障将限制它所能做的重排序优化。而对于处理器而言，内存屏障将会导致缓存的刷新操作。比如，对于volatile，编译器将在volatile字段的读写操作前后各插入一些内存屏障。</p>
<p>——<strong>Healtheon</strong></p>
</li>
</ol>
</blockquote>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">Wendell</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="https://wendell-z.github.io/posts/2020/03/29/Java%E5%B9%B6%E5%8F%912-Happens-Before%E8%A7%84%E5%88%99/">https://wendell-z.github.io/posts/2020/03/29/Java%E5%B9%B6%E5%8F%912-Happens-Before%E8%A7%84%E5%88%99/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">Wendell</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Java/">
                                    <span class="chip bg-color">Java</span>
                                </a>
                            
                                <a href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">
                                    <span class="chip bg-color">并发编程</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="fas fa-chevron-left"></i>&nbsp;上一篇</div>
            <div class="card">
                <a href="/2020/04/06/Java%E5%B9%B6%E5%8F%913-%E4%BA%92%E6%96%A5%E9%94%81(%E4%B8%8A)/">
                    <div class="card-image">
                        
                        <img src="https://images-1252818907.cos.ap-chengdu.myqcloud.com/images/java并发编程.jpg" class="responsive-img" alt="Java并发3:互斥锁(上)">
                        
                        <span class="card-title">Java并发3:互斥锁(上)</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            互斥锁解决原子性问题
                        
                    </div>
                    <div class="publish-info">
                        <span class="publish-date">
                            <i class="far fa-clock fa-fw icon-date"></i>2020-04-06
                        </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%90%8E%E7%AB%AF/" class="post-category">
                                    后端
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Java/">
                        <span class="chip bg-color">Java</span>
                    </a>
                    
                    <a href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">
                        <span class="chip bg-color">并发编程</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2020/03/29/Java%E5%B9%B6%E5%8F%911-%E5%B9%B6%E5%8F%91%E9%97%AE%E9%A2%98%E6%BA%90%E5%A4%B4/">
                    <div class="card-image">
                        
                        <img src="https://images-1252818907.cos.ap-chengdu.myqcloud.com/images/java并发编程.jpg" class="responsive-img" alt="Java并发1:并发问题源头">
                        
                        <span class="card-title">Java并发1:并发问题源头</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            分析并发问题源头
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2020-03-29
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-bookmark fa-fw icon-category"></i>
                            
                            <a href="/categories/%E5%90%8E%E7%AB%AF/" class="post-category">
                                    后端
                                </a>
                            
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Java/">
                        <span class="chip bg-color">Java</span>
                    </a>
                    
                    <a href="/tags/%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B/">
                        <span class="chip bg-color">并发编程</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 15px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2020-2021</span>
            
            <span id="year">2020</span>
            <a href="/about" target="_blank">Wendell Zhang</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            &nbsp;<i class="fas fa-chart-area"></i>&nbsp;站点总字数:&nbsp;<span
                class="white-color">54.6k</span>&nbsp;字
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <span id="sitetime">载入运行时间...</span>
            <script>
                function siteTime() {
                    var seconds = 1000;
                    var minutes = seconds * 60;
                    var hours = minutes * 60;
                    var days = hours * 24;
                    var years = days * 365;
                    var today = new Date();
                    var startYear = "2020";
                    var startMonth = "3";
                    var startDate = "9";
                    var startHour = "0";
                    var startMinute = "0";
                    var startSecond = "0";
                    var todayYear = today.getFullYear();
                    var todayMonth = today.getMonth() + 1;
                    var todayDate = today.getDate();
                    var todayHour = today.getHours();
                    var todayMinute = today.getMinutes();
                    var todaySecond = today.getSeconds();
                    var t1 = Date.UTC(startYear, startMonth, startDate, startHour, startMinute, startSecond);
                    var t2 = Date.UTC(todayYear, todayMonth, todayDate, todayHour, todayMinute, todaySecond);
                    var diff = t2 - t1;
                    var diffYears = Math.floor(diff / years);
                    var diffDays = Math.floor((diff / days) - diffYears * 365);
                    var diffHours = Math.floor((diff - (diffYears * 365 + diffDays) * days) / hours);
                    var diffMinutes = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours) /
                        minutes);
                    var diffSeconds = Math.floor((diff - (diffYears * 365 + diffDays) * days - diffHours * hours -
                        diffMinutes * minutes) / seconds);
                    if (startYear == todayYear) {
                        document.getElementById("year").innerHTML = todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffDays + " 天 " + diffHours +
                            " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    } else {
                        document.getElementById("year").innerHTML = startYear + " - " + todayYear;
                        document.getElementById("sitetime").innerHTML = "本站已安全运行 " + diffYears + " 年 " + diffDays +
                            " 天 " + diffHours + " 小时 " + diffMinutes + " 分钟 " + diffSeconds + " 秒";
                    }
                }
                setInterval(siteTime, 1000);
            </script>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="https://github.com/Wendell-Z" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>



    <a href="mailto:coder.wendell@gmail.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>







    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1024762489" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1024762489" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>







    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>

</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
